#+TITLE: lan-mouse monitor for laptops (client)
#+AUTHOR: Rafael Ito
#+PROPERTY: header-args :tangle lanmouse-monitor_laptop.sh
#+DESCRIPTION: monitor lan-mouse logs and run appropriate commands on laptops (client)
#+STARTUP: showeverything
#+auto_tangle: t

* Table of Contents :toc_3:
- [[#header][Header]]
- [[#variables][Variables]]
- [[#monitoring][Monitoring]]
  - [[#laptop----desktop][Laptop --> Desktop]]
  - [[#desktop----laptop][Desktop --> Laptop]]
  - [[#eos][EoS]]

* Header :noexport_1:
** Shebang
#+begin_src sh
#!/usr/bin/env bash
#+end_src
** Description
#+begin_src sh
# description:
#   script to share clipboard via lan-mouse (software KVM) with the sender host.
# how it works:
#   it monitors the output of the journal for the lan-mouse unit, and once it 
#   detects that the cursor moved back to the sender, it runs push-clipboard.sh
#   script that sends the clipboard back via SSH forced commands (previously 
#   configured in ~/.ssh/authorized-keys).
#+end_src
** Help menu
#+begin_src sh
# Usage:
#   This is script is meant to be used as a daemon. A systemd user service
#   is responsible for launching and controlling it.
#+end_src
* Variables
#+begin_src sh
# define systemd unit to monitor
UNIT="lanmouse"
# define message to monitor on the output of journalctl
TRIGGER_ENTERING=".*releasing capture: [0-9.:]+ entered this device.*"
TRIGGER_LEAVING="releasing capture: no active client at this position"
# set cooldown (in miliseconds) to avoid double trigger
COOLDOWN=250
LAST_TRIGGER=0
#+end_src
* Monitoring
#+begin_src sh
# monitor the journal for the specific user unit
journalctl --user -u $UNIT -f -n 0 | while read -r line; do
CURRENT_TIME=$(($(date +%s%N)/1000000))
#+end_src
** Laptop --> Desktop
Leaving laptop. Share clipboard with sender.
  - client --> server
  - receiving --> sender
#+begin_src sh
# leaving this host --> returning to desktop
if [[ "$line" == *"$TRIGGER_LEAVING"* ]]; then
    # check if enough time (cooldown) has passed since the last trigger
    if (( CURRENT_TIME - LAST_TRIGGER >= COOLDOWN )); then
        echo -n "[$(date '+%Y-%m-%d %H:%M:%S')] Mouse returned to PC. Sending clipboard..."
        # send clipboard via SSH forced command
        $HOME/.config/scripts/push-clipboard.sh catuaba > /dev/null
        # append "Done!" or "Failed!" to the previous line according to the script status
        [ $? -eq 0 ] && echo " Done!" || echo " Failed!"
        LAST_TRIGGER=$CURRENT_TIME
    fi
#+end_src
** Desktop --> Laptop 
Entering laptop. No functionality yet.
  - server --> client
  - sender --> receiving
#+begin_src sh
## entering this host
#elif [[ "$line" =~ $TRIGGER_ENTERING ]]; then
#    #IP_ADDRESS=${BASH_REMATCH[1]}  # --> not working
#    echo -n "[$(date '+%Y-%m-%d %H:%M:%S')] Mouse just entered in this host. Do something useful..."
#    #ssh catuaba 'export SWAYSOCK=$(ls -t /run/user/1000/sway-ipc.1000.*.sock | head -1); swaymsg "[app_id=edge_bottom] focus"'
#    # append "Done!" or "Failed!" to the previous line according to the script status
#    [ $? -eq 0 ] && echo " Done!" || echo " Failed!"
#+end_src
** EoS
#+begin_src sh
    fi
done
#+end_src
